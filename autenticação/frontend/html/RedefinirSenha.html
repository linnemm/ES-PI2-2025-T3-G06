<!--Código html (Redefinir a senha) feito por Miriã-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir a senha</title>
    <link rel="stylesheet" href="../css/RedefinirSenha.css">
    <!--Biblioteca para o ícono do olho de senha-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  </head>

<body>

    <!--Classes-->
    <div class="background-box">
    
    <!-- Quadrado branco dentro do fundo verde -->
    <div class="esqueceu_senha-container">
      <!-- Bandeirinhas -->
      <div class="bandeirinhas">
        <div class="flamula">N</div>
        <div class="flamula">O</div>
        <div class="flamula">T</div>
        <div class="flamula">A</div>
        <div class="flamula">D</div>
        <div class="flamula">E</div>
        <div class="flamula">Z</div>
      </div>

      <!--Formulário de nova senha-->

<form id="formRedefinirSenha"> 
    <h1>Redefinir Senha</h1>

      <!--Digitar nova senha-->
    <div class="input-wrapper password-container">
            <input type="password" placeholder="Digite a nova senha" id="password1" name="senha" required />
            <span id="togglePassword" class="toggle-password"></span>
        </div>

      <!--Confirmar a senha-->
    <div class="input-wrapper password-container">
            <input type="password" placeholder="Confirme a senha" id="password2" name="senha" required />
            <span id="togglePassword2" class="toggle-password"></span>
        </div>

    <p id="errorMsg" class="error-message"></p>

    <br><button type="submit">Redefinir senha</button>
</form>
</div>
</div>
      

<script>
    const form = document.getElementById("formRedefinirSenha");
    const errorMsg = document.getElementById("errorMsg");

    // Função para exibir/ocultar senha
    const toggle1 = document.getElementById("togglePassword");
    const toggle2 = document.getElementById("togglePassword2");
    const senha1 = document.getElementById("password1");
    const senha2 = document.getElementById("password2");

    toggle1.addEventListener("click", () => {
      const isPassword = senha1.type === "password";
      senha1.type = isPassword ? "text" : "password";
      toggle1.classList.toggle("visible", isPassword);
    });

    toggle2.addEventListener("click", () => {
      const isPassword = senha2.type === "password";
      senha2.type = isPassword ? "text" : "password";
      toggle2.classList.toggle("visible", isPassword);
    });

    // Captura o token da URL
    const token = new URLSearchParams(window.location.search).get("token");

    if (!token) {
      alert("Link inválido! O token de redefinição não foi encontrado.");
      window.location.href = "login.html";
    }

    // Envio do formulário
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const novaSenha = senha1.value.trim();
      const confirmar = senha2.value.trim();

      errorMsg.style.display = "none";
      errorMsg.textContent = "";

      // Validações
      if (novaSenha.length < 6) {
        errorMsg.textContent = "A senha deve ter pelo menos 6 caracteres.";
        errorMsg.style.display = "block";
        return;
      }

      if (novaSenha !== confirmar) {
        errorMsg.textContent = "As senhas não coincidem.";
        errorMsg.style.display = "block";
        return;
      }

      const botao = form.querySelector("button");
      botao.disabled = true;
      botao.innerText = "Redefinindo...";

      try {
        // Faz requisição para o backend
        const resposta = await fetch("http://localhost:3000/api/auth/reset-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, novaSenha }),
        });

        const dados = await resposta.json();

        if (resposta.ok) {
          alert("✅ " + dados.message);
          window.location.href = "login.html";
        } else {
          alert("❌ " + (dados.message || "Erro ao redefinir senha."));
        }
      } catch (erro) {
        console.error("Erro ao conectar com o servidor:", erro);
        alert("Erro ao conectar com o servidor. Tente novamente mais tarde.");
      } finally {
        botao.disabled = false;
        botao.innerText = "Redefinir senha";
      }
    });
</script>

</body>
</html>