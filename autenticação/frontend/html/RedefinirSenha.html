<!--Código html (Redefinir a senha) feito por Miriã-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir a senha</title>
    <link rel="stylesheet" href="../css/RedefinirSenha.css">
    <!--Biblioteca para o ícono do olho de senha-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  </head>

<body>

    <!--Classes-->
    <div class="background-box">
    
    <!-- Quadrado branco dentro do fundo verde -->
    <div class="esqueceu_senha-container">
      <!-- Bandeirinhas -->
      <div class="bandeirinhas">
        <div class="flamula">N</div>
        <div class="flamula">O</div>
        <div class="flamula">T</div>
        <div class="flamula">A</div>
        <div class="flamula">D</div>
        <div class="flamula">E</div>
        <div class="flamula">Z</div>
      </div>

      <!--Formulário de nova senha-->

<form id="formRedefinirSenha"> 
    <h1>Redefinir Senha</h1>

      <!--Digitar nova senha-->
    <div class="input-wrapper password-container">
            <input type="password" placeholder="Digite a nova senha" id="password1" name="senha" required />
            <span id="togglePassword" class="toggle-password"></span>
        </div>

      <!--Confirmar a senha-->
    <div class="input-wrapper password-container">
            <input type="password" placeholder="Confirme a senha" id="password2" name="senha" required />
            <span id="togglePassword2" class="toggle-password"></span>
        </div>

    <p id="errorMsg" class="error-message"></p>

    <br><button type="submit">Redefinir senha</button>
</form>
</div>
</div>
      

<script>
  // Função para pegar o token da URL (ex: ?token=abcdef)
  function getTokenFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('token');
  }

  const form = document.getElementById('formRedefinirSenha');
  const errorMsg = document.getElementById('errorMsg');

  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const senha1 = document.getElementById('password1').value.trim();
    const senha2 = document.getElementById('password2').value.trim();
    const token = getTokenFromURL();

    errorMsg.style.display = 'none';
    errorMsg.textContent = '';

    if (!token) {
      errorMsg.textContent = 'Link de redefinição inválido ou expirado.';
      errorMsg.style.display = 'block';
      return;
    }

    if (senha1.length < 6) {
      errorMsg.textContent = 'A senha deve ter pelo menos 6 caracteres.';
      errorMsg.style.display = 'block';
      return;
    }

    if (senha1 !== senha2) {
      errorMsg.textContent = 'As senhas não coincidem.';
      errorMsg.style.display = 'block';
      return;
    }

    try {
      const response = await fetch('http://localhost:3000/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          token,
          newPassword: senha1
        })
      });

      if (response.ok) {
        alert('Senha redefinida com sucesso!');
        window.location.href = 'login.html';
      } else {
        const data = await response.json();
        errorMsg.textContent = data.message || 'Erro ao redefinir senha.';
        errorMsg.style.display = 'block';
      }
    } catch (error) {
      console.error(error);
      errorMsg.textContent = 'Erro de conexão com o servidor.';
      errorMsg.style.display = 'block';
    }
  });
</script>


</body>
</html>